SELECT
  a.WELL_ID,
  a.PROD_DATE,
  a.ON_STREAM_HRS,
  CASE 
    WHEN a.ON_STREAM_HRS > 0 THEN 0
    ELSE ROW_NUMBER() OVER (PARTITION BY a.WELL_ID, a.grp ORDER BY a.PROD_DATE)
  END AS days_since_last_prod
FROM (
  SELECT *,
         SUM(CASE WHEN ON_STREAM_HRS > 0 THEN 1 ELSE 0 END) 
         OVER (PARTITION BY WELL_ID ORDER BY PROD_DATE) AS grp
  FROM (
    SELECT
      WELL_ID,
      PROD_DATE,
      MAX(ON_STREAM_HRS) AS ON_STREAM_HRS
    FROM OPGI_DATA_FILTER
    GROUP BY WELL_ID, PROD_DATE
  ) sub
) a
================

SELECT 
  A.WELL_ID,
  A.PROD_DATE,
  A.ON_STREAM_HRS,
  CASE 
    WHEN A.ON_STREAM_HRS > 0 THEN 0
    ELSE AGG.days_since_last_prod
  END AS days_since_last_prod
FROM OPGI_DATA_FILTER A
LEFT JOIN (
  SELECT 
    WELL_ID,
    PROD_DATE,
    CASE 
      WHEN ON_STREAM_HRS_DAILY > 0 THEN 0
      ELSE ROW_NUMBER() OVER (
        PARTITION BY WELL_ID, grp 
        ORDER BY PROD_DATE
      )
    END AS days_since_last_prod
  FROM (
    SELECT 
      WELL_ID,
      PROD_DATE,
      MAX(ON_STREAM_HRS) AS ON_STREAM_HRS_DAILY,
      SUM(
        CASE WHEN MAX_ON_STREAM > 0 THEN 1 ELSE 0 END
      ) OVER (
        PARTITION BY WELL_ID 
        ORDER BY PROD_DATE
      ) AS grp
    FROM (
      SELECT 
        WELL_ID,
        PROD_DATE,
        MAX(ON_STREAM_HRS) AS MAX_ON_STREAM
      FROM OPGI_DATA_FILTER
      GROUP BY WELL_ID, PROD_DATE
    ) daily
  ) grouped
) AGG
ON A.WELL_ID = AGG.WELL_ID AND A.PROD_DATE = AGG.PROD_DATE

